(()=>{"use strict";var t={429:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.listingsLatest=void 0;const o=r(n(167)),c=n(569);e.listingsLatest=()=>i(void 0,void 0,void 0,(function*(){return(yield o.default.get("https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest",{headers:{"X-CMC_PRO_API_KEY":"f6b23270-09fd-4fe9-b7fe-17ff50744077"}})).data.data.map(c.mapListingLatest)}))},569:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.mapListingLatest=void 0,e.mapListingLatest=t=>({cryptocurrencyName:t.symbol,priceUsd:t.quote.USD.price,rank:t.cmc_rank,platformName:"coinmarketcap"})},631:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.tickers=void 0;const o=r(n(167)),c=n(90);e.tickers=()=>i(void 0,void 0,void 0,(function*(){return(yield o.default.get("https://api.coinpaprika.com/v1/tickers")).data.map(c.mapTickers)}))},90:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.mapTickers=void 0,e.mapTickers=t=>({cryptocurrencyName:t.symbol,priceUsd:t.quotes.USD.price,rank:t.rank,platformName:"coinpaprika"})},107:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.coins=void 0;const o=r(n(167)),c=n(14);e.coins=()=>i(void 0,void 0,void 0,(function*(){return(yield o.default.get("https://api.coinstats.app/public/v1/coins?currency=USD")).data.coins.map(c.mapCoins)}))},14:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.mapCoins=void 0,e.mapCoins=t=>({cryptocurrencyName:t.symbol,priceUsd:t.price,rank:t.rank,platformName:"coinstats"})},827:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(860)),c=r(n(881)),a=n(429),s=n(631),u=n(107);e.default=class{constructor(t){this.latestCryptocurrencies=(t,e,n)=>i(this,void 0,void 0,(function*(){const t=yield this.cryptocurrencyRepository.getLatestCryptocurrencies();e.status(200).json(t)})),this.updateCryptocurrencies=()=>i(this,void 0,void 0,(function*(){const t=yield this.getCryptocurrencies();yield this.cryptocurrencyRepository.rewriteLatestCryptocurrencies(t)})),this.getCryptocurrencies=()=>i(this,void 0,void 0,(function*(){const t=yield(0,a.listingsLatest)(),e=yield(0,s.tickers)(),n=yield(0,u.coins)(),i=Date.now(),r=[t,e,n],o=new Map;return r.forEach((t=>{t.forEach((({cryptocurrencyName:t,rank:e,priceUsd:n,platformName:i})=>{const r=o.get(t);if(r){if(r.price[i])return;o.set(t,{cryptocurrencyName:t,markets:r.markets+1,rank:r.rank+e,price:Object.assign(Object.assign({},r.price),{[i]:n})})}else o.set(t,{cryptocurrencyName:t,markets:1,rank:e,price:{[i]:n}})}))})),Array.from(o.values()).sort(((t,e)=>t.markets!==e.markets?e.markets-t.markets:t.rank-e.rank)).slice(0,20).map((t=>({cryptocurrencyName:t.cryptocurrencyName,timestamp:i,coinpaprikaValue:t.price.coinpaprika,coinstatsValue:t.price.coinstats,coinmarketcapValue:t.price.coinmarketcap})))})),this.cryptocurrencyRepository=new c.default(t.connection),this.router=o.default.Router(),this.router.get("/latestCryptocurrencies",this.latestCryptocurrencies)}}},779:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(418));class c{constructor(t){this.connection=t}}c.init=()=>i(void 0,void 0,void 0,(function*(){const t=yield o.default.createConnection({host:"us-cdbr-east-06.cleardb.net",user:"dima",password:"c92585bc",database:process.env.DATABASE});return console.log("Database connected"),new c(t)})),e.default=c},781:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SQLTimestampToTimestamp=e.timestampToSQLTimestamp=void 0,e.timestampToSQLTimestamp=t=>new Date(t).toISOString().replace("T"," ").slice(0,19),e.SQLTimestampToTimestamp=t=>t.getTime()},303:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))},r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const o=r(n(860)),c=r(n(986)),a=r(n(827)),s=r(n(125)),u=r(n(168)),l=r(n(779)),p=r(n(881)),d=(0,o.default)();i(void 0,void 0,void 0,(function*(){const t=yield l.default.init();yield new p.default(t.connection).initTables();const e=new a.default(t);d.use(c.default.json({limit:"100kb",type:"*/*"})),d.use(u.default),d.use(e.router),d.use(s.default),d.listen(3103,(()=>{console.log("App listening at http://localhost:3103")}))}))},125:function(t,e,n){var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const r=i(n(643));e.default=(t,e,n,i)=>{t instanceof r.default?n.status(t.status).send({error:{message:t.message}}):t instanceof Error?n.status(500).send({error:{message:t.message}}):n.status(500).send({error:{message:"Internal Server Error"}})}},168:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.default=(t,e,n,i)=>{"SyntaxError"==t.name&&(n.status(400),n.send({status:400,message:"Bad Request!"})),i()}},881:function(t,e,n){var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function c(t){try{s(i.next(t))}catch(t){o(t)}}function a(t){try{s(i.throw(t))}catch(t){o(t)}}function s(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(c,a)}s((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0});const r=n(781);e.default=class{constructor(t){this.initTables=()=>i(this,void 0,void 0,(function*(){yield this.connection.execute({sql:"\n          CREATE TABLE IF NOT EXISTS 'latestCryptocurrencies' (\n            cryptocurrencyName varchar(255) NOT NULL,\n            timestamp timestamp NOT NULL,\n            coinpaprikaValue double,\n            coinstatsValue double,\n            coinmarketcapValue double\n          );\n        "}),console.log("Cryptocurrency initialized successfully.")})),this.getLatestCryptocurrencies=()=>i(this,void 0,void 0,(function*(){const[t]=yield this.connection.execute({sql:"SELECT * FROM latestCryptocurrencies;"});return t.map((t=>Object.assign(Object.assign({},t),{timestamp:(0,r.SQLTimestampToTimestamp)(t.timestamp)})))})),this.rewriteLatestCryptocurrencies=t=>i(this,void 0,void 0,(function*(){yield this.connection.execute("DELETE FROM latestCryptocurrencies;");const e=t.map((({cryptocurrencyName:t,timestamp:e,coinpaprikaValue:n,coinstatsValue:i,coinmarketcapValue:o})=>[t,(0,r.timestampToSQLTimestamp)(e),n,i,o])),n=this.connection.format("INSERT INTO latestCryptocurrencies (cryptocurrencyName, timestamp, coinpaprikaValue, coinstatsValue, coinmarketcapValue) VALUES ?",[e]);yield this.connection.execute(n)})),this.connection=t}}},643:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0});class n extends Error{constructor(t,e){super(e),this.status=t}}e.default=n},167:t=>{t.exports=require("axios")},986:t=>{t.exports=require("body-parser")},860:t=>{t.exports=require("express")},418:t=>{t.exports=require("mysql2/promise")}},e={};!function n(i){var r=e[i];if(void 0!==r)return r.exports;var o=e[i]={exports:{}};return t[i].call(o.exports,o,o.exports,n),o.exports}(303)})();